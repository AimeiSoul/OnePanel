/** OnePanel æ ¸å¿ƒè„šæœ¬ - æ•´åˆè®¿å®¢/ç”¨æˆ·æ¨¡å¼ */
const DEFAULT_BG = "/static/default_bg.jpg";
const ENGINES = {
    bing: { name: 'Bing', url: 'https://www.bing.com/search?q=', logo: 'https://www.bing.com/favicon.ico' },
    baidu: { name: 'Baidu', url: 'https://www.baidu.com/s?wd=', logo: 'https://www.baidu.com/favicon.ico' },
    google: { name: 'Google', url: 'https://www.google.com/search?q=', logo: 'https://www.google.com/favicon.ico' }
};
let currentEngine = 'bing';


/** æ ¸å¿ƒåˆå§‹åŒ–ï¼šé¡µé¢åŠ è½½æ—¶è¿è¡Œ */
async function initPage() {
    const bgLayer = document.getElementById('bg-layer');
    const authZone = document.getElementById('auth-zone');
    const linksContainer = document.getElementById('links-container');
    const token = localStorage.getItem('onepanel_token');

    startClock();

    // 1. ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ (ä¿æŒä¸å˜)
    try {
        const res = await fetch('/api/system/status');
        const status = await res.json();
        if (!status.is_initialized) return window.location.href = '/static/init.html';
    } catch (e) { console.error("ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥", e); }

    // 2. èº«ä»½è¯†åˆ«ï¼ˆæ ¸å¿ƒä¿®æ­£ç‚¹ï¼‰
    let isUserVerified = false;
    if (token) {
        try {
            const userRes = await fetch('/api/user/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (userRes.ok) {
                const userData = await userRes.json();
                showUserMode(userData, bgLayer, authZone); // æ¸²æŸ“ç”¨æˆ·ç•Œé¢
                isUserVerified = true;
            } else if (userRes.status === 401) {
                console.warn("Token å·²å¤±æ•ˆï¼Œæ¸…ç†ç™»å½•æ€");
                localStorage.removeItem('onepanel_token');
            }
        } catch (e) {
            console.error("ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•éªŒè¯èº«ä»½", e);
        }
    }
    
    // 3. å¦‚æœéªŒè¯æ²¡é€šè¿‡ï¼ˆæ²¡ Tokenï¼Œæˆ–è€… Token æŠ¥é”™äº†ï¼‰ï¼Œæ¸²æŸ“è®¿å®¢æ€
    if (!isUserVerified) {
        resetToGuestUI(bgLayer, authZone);
    }

    // 4. åŠ è½½é“¾æ¥
    renderLinks(linksContainer);
    initSearchLogic();
}

/** å®æ—¶æ—¶é’Ÿé€»è¾‘ */

function startClock() {
    const clockEl = document.getElementById('live-clock');
    const dateEl = document.getElementById('live-date');

    if (!clockEl || !dateEl) return;

    function update() {
        const now = new Date();
        // 1. å¤„ç†æ—¶é—´ (17:21:05)
        const hrs = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const sec = String(now.getSeconds()).padStart(2, '0');
        clockEl.textContent = `${hrs}:${min}:${sec}`;

        // 2. å¤„ç†æ—¥æœŸæ ¼å¼ (02-05 Wed)
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const week = weekdays[now.getDay()];

        // æœ€ç»ˆæ ¼å¼åŒ–æ˜¾ç¤º
        dateEl.textContent = `${month}-${day} ${week}`;
    }

    // æ¯ä¸€ç§’æ›´æ–°ä¸€æ¬¡
    setInterval(update, 1000);
    update(); // ç«‹å³æ‰§è¡Œï¼Œé¿å…åˆæ¬¡åŠ è½½ç™½å±
}

/** ä»…æ›´æ–° UI ä¸ºè®¿å®¢æ¨¡å¼ï¼Œä¸å¼ºåˆ¶åˆ é™¤æœ¬åœ° Token */
function resetToGuestUI(bg, zone) {
    bg.style.backgroundImage = `url('${DEFAULT_BG}')`;
    zone.innerHTML = `<button class="glass-btn" onclick="window.location.href='/static/login.html'">ğŸ”‘ ç™»å½• / æ³¨å†Œ</button>`;
}

/** ç”¨æˆ·æ¨¡å¼ UI æ¸²æŸ“ */
function showUserMode(user, bg, zone) {
    // 1. è®¾ç½®èƒŒæ™¯
    bg.style.backgroundImage = `url('${user.custom_bg || DEFAULT_BG}')`;

    // 2. è§£æéšè—åˆ—è¡¨
    const hiddenStr = user.hidden_groups || "";
    const hiddenList = hiddenStr.split(',').filter(x => x.trim() !== "");
    // æ£€æŸ¥æ˜¯å¦éšè—äº†å…¬å…±åˆ†ç»„ (ID=1)
    const isPublicHidden = hiddenList.includes("1");

    // 3. æ¸²æŸ“æŒ‰é’®ç»„
    zone.innerHTML = `
        <span class="user-info">ğŸ‘¤ ${user.username}</span>
        
        ${isPublicHidden ? 
            `<button class="glass-btn pulse-hint" style="background: rgba(102, 204, 255, 0.3);" onclick="toggleGroupVisibility(1)">ğŸ‘ï¸ å…¬å…±ç»„</button>` : 
            ''
        }
        <button class="glass-btn" onclick="document.getElementById('bg-input').click()">âœ¨ æ¢èƒŒæ™¯</button>
        <button class="glass-btn" onclick="openGroupModal()">ğŸ“ å»ºåˆ†ç»„</button>
        <button class="glass-btn" onclick="openModal()">â• æ·»é“¾æ¥</button>
        <button class="glass-btn" onclick="logout()">ğŸšª é€€å‡º</button>
    `;
}


/** è®¿å®¢æ¨¡å¼ UI æ¸²æŸ“ */

function resetToGuest(bg, zone) {
    bg.style.backgroundImage = `url('${DEFAULT_BG}')`;
    zone.innerHTML = `<button class="glass-btn" onclick="window.location.href='/static/login.html'">ğŸ”‘ ç™»å½• / æ³¨å†Œ</button>`;
    localStorage.removeItem('onepanel_token');
}


/** è·å–åˆ†ç»„æ•°æ® */
async function fetchGroups() {
    const token = localStorage.getItem('onepanel_token');
    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

    // æ³¨æ„è¿™é‡Œæ˜¯ /api/groups/ æœ«å°¾å¸¦æ–œæ ï¼Œä¸”æ˜¯å¤æ•°
    const res = await fetch('/api/groups/', { headers });

    if (!res.ok) {
        const errorText = await res.text();
        console.error(`è¯·æ±‚å¤±è´¥: ${res.status}`, errorText);
        throw new Error("æ— æ³•ä»æœåŠ¡å™¨è·å–åˆ†ç»„æ•°æ®");
    }
    return await res.json();
}

// ç»Ÿä¸€çš„æ˜¾éšåˆ‡æ¢å‡½æ•°
async function toggleGroupVisibility(groupId) {
    const token = localStorage.getItem('onepanel_token');
    try {
        const res = await fetch(`/api/groups/${groupId}/toggle-visibility`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            // æˆåŠŸåç›´æ¥åˆ·æ–°ï¼Œé¡µé¢ä¼šæ ¹æ®æ–°çš„ hidden_groups æ¸²æŸ“
            window.location.reload();
        }
    } catch (e) {
        console.error("åˆ‡æ¢å¯è§æ€§å¤±è´¥:", e);
    }
}

function hideGroup(groupId) {
    if (confirm('ç¡®å®šéšè—æ­¤åˆ†ç»„å—ï¼Ÿéšè—åå¯åœ¨ä¸ªäººèœå•ä¸­æ¢å¤ã€‚')) {
        toggleGroupVisibility(groupId);
    }
}

function renderGroups(groups) {
    const container = document.getElementById('links-container');
    const token = localStorage.getItem('onepanel_token'); // æ£€æŸ¥ç™»å½•çŠ¶æ€

    if (!groups || groups.length === 0) {
        container.innerHTML = `<div class="empty-state">æš‚æ— å…¬å¼€åˆ†ç»„</div>`;
        return;
    }

    container.innerHTML = groups.map(group => {
        const hasLinks = group.links && group.links.length > 0;

        // æ ¸å¿ƒï¼šå¤„ç†ç©ºé“¾æ¥çš„æƒ…å†µ
        const linksContent = hasLinks ?
            group.links.map(l => `
                <div class="link-card" data-link-id="${l.id}">
                    ${token ? `<div class="delete-btn" onclick="confirmDelete(event, ${l.id})"></div>` : ''}
                    <a href="${l.url}" target="_blank">
                        <div class="icon-wrapper">
                            <img src="https://favicon.cccyun.cc/${new URL(l.url).hostname}" onerror="this.src='/static/default_link.jpg'">
                        </div>
                        <div class="link-title">${l.title}</div>
                    </a>
                </div>
            `).join('') :
            `<div class="empty-link-placeholder">
                <i class="fas fa-plus-circle"></i> 
                <span>æš‚æ— é“¾æ¥${token ? 'ï¼Œç‚¹å‡»â€œæ·»é“¾æ¥â€æˆ–â€œå»ºåˆ†ç»„â€å¼€å§‹' : ''}</span>
            </div>`;

        return `
            <div class="group-section" data-id="${group.id}">
                <div class="group-header">
                    ${token ? `<span class="group-drag-handle">â ¿</span>` : ''}
                    <h3 class="group-title">${group.name}</h3>
                    ${token ? `<span class="group-del-btn" onclick="confirmDeleteGroup(${group.id})">Ã—</span>` : ''}
                </div>
                <div class="links-grid ${!hasLinks ? 'empty-grid' : ''}" data-group-id="${group.id}">
                    ${linksContent}
                </div>
            </div>
        `;
    }).join('');

    if (token) initSortable();
}


/** æ¸²æŸ“åˆ†ç»„åŠå…¶é“¾æ¥ (æ ¸å¿ƒå±‚çº§é€»è¾‘) */
async function renderLinks(container) {
    const token = localStorage.getItem('onepanel_token');
    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

    let userData = null;
    if (token) {
        try {
            const userRes = await fetch('/api/user/me', { headers }); // ç¡®ä¿æ¥å£è·¯å¾„æ­£ç¡®
            if (userRes.ok) userData = await userRes.json();
        } catch (e) { console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥", e); }
    }

    try {
        const fetchUrl = token ? '/api/groups/' : '/api/groups/public';
        const response = await fetch(fetchUrl, { headers });
        const groups = await response.json();

        if (!Array.isArray(groups)) {
            throw new Error("è¿”å›æ•°æ®æ ¼å¼é”™è¯¯");
        }

        if (!groups || groups.length === 0) {
            container.innerHTML = `<div class="empty-state">æš‚æ— å†…å®¹ï¼Œç‚¹å‡»â€œæ·»é“¾æ¥â€æˆ–â€œå»ºåˆ†ç»„â€å¼€å§‹</div>`;
            return;
        }

        container.innerHTML = groups.map(group => {
            const links = group.links || [];
            const isPublic = group.id === 1;
            const isReadonly = isPublic && (!userData || userData.id !== 1);
            const canHide = isPublic && userData !== null;

            // 1. å®šä¹‰å ä½ç¬¦ (ä¸å†ä½œä¸º else åˆ†æ”¯ï¼Œè€Œæ˜¯å§‹ç»ˆç”Ÿæˆ)
            const placeholderHtml = `
                <div class="empty-link-placeholder">
                    <span style="color:rgba(255,255,255,0.3); font-size:14px;">æš‚æ— é“¾æ¥</span>
                    ${token ? '<span style="color:#66ccff; font-size:12px; margin-top:5px; display:block;">ç‚¹å‡»â€œæ·»é“¾æ¥â€å¼€å§‹</span>' : ''}
                </div>`;

            // 2. ç”Ÿæˆé“¾æ¥å¡ç‰‡åˆ—è¡¨
            const cardsHtml = links.map(l => {
                let hostname = "";
                try { hostname = new URL(l.url).hostname; } catch (e) { hostname = "invalid"; }
                const favicon = `https://favicon.cccyun.cc/${hostname}`;

                return `
                    <div class="link-card" id="link-${l.id}" data-link-id="${l.id}">
                        ${(token && !isReadonly) ? `<div class="delete-btn" onclick="confirmDelete(event, ${l.id})"></div>` : ''}
                        <a href="${l.url}" target="_blank" style="text-decoration: none; display: flex; flex-direction: column; align-items: center;">
                            <div class="icon-wrapper">
                                <img src="${favicon}"
                                     onerror="this.src='/static/default_link.jpg'"
                                     style="width: 30px; height: 30px; object-fit: contain;">
                            </div>
                            <div class="link-title">${l.title}</div>
                        </a>
                    </div>`;
            }).join('');

            // 3. å°†ä¸¤è€…æ‹¼æ¥åœ¨ä¸€èµ·æ”¾å…¥ grid
            return `
            <div class="group-section ${isReadonly ? 'readonly-group' : ''}" data-id="${group.id}">
                <div class="group-header">
                    ${(token && !isReadonly) ? `<span class="group-drag-handle">â ¿</span>` : ''}
                    <h3 class="group-title" ${(token && !isReadonly) ? `onclick="editGroupName(this, ${group.id})"` : ''}>
                        ${group.name} ${isPublic ? '<span class="public-badge">å…¬å…±</span>' : ''}
                    </h3>
                    ${isPublic ? 
                        (canHide ? `<span class="group-hide-btn" onclick="hideGroup(${group.id})">Ã—</span>` : '') :
                        (token ? `<span class="group-del-btn" onclick="confirmDeleteGroup(${group.id})">Ã—</span>` : '')
                    }
                </div>
                <div class="links-grid" id="grid-${group.id}" data-group-id="${group.id}">
                    ${placeholderHtml}
                    ${cardsHtml}
                </div>
            </div>`;
        }).join('');

        if (token) initSortable(userData);;
        groups.forEach(g => g.links?.forEach(l => checkUrlAccessibility(l.url, `link-${l.id}`)));

    } catch (e) {
        console.error("åŠ è½½å¤±è´¥:", e);
        container.innerHTML = `<div style="color:red">æ•°æ®åŠ è½½å¼‚å¸¸</div>`;
    }
}


function initLinkSortable(groupId) {
    const el = document.getElementById(`grid-${groupId}`);
    if (!el) return;

    new Sortable(el, {
        group: 'links-shared',
        animation: 150,
        handle: '.icon-wrapper',
        // å…³é”®ï¼šæ‹–æ‹½ç»“æŸæ—¶è§¦å‘
        onEnd: async function (evt) {
            const { to, from } = evt;

            // æ ¸å¿ƒå‡½æ•°ï¼šåŒæ­¥å•ä¸ªåˆ†ç»„çš„æ’åº
            const syncGroup = async (targetEl) => {
                const groupId = parseInt(targetEl.dataset.groupId);
                // å…³é”®ç‚¹ï¼šæŒ‰ HTML é‡Œçš„å®é™…é¡ºåºæŠ“å– ID
                const linkIds = Array.from(targetEl.querySelectorAll('.link-card'))
                    .map(card => parseInt(card.dataset.linkId));

                const token = localStorage.getItem('onepanel_token');
                await fetch(`/api/links/reorder`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        link_ids: linkIds,
                        group_id: groupId
                    })
                });
            };

            // æ‰§è¡ŒåŒæ­¥
            await syncGroup(to);
            // å¦‚æœæ˜¯è·¨ç»„æ‹–æ‹½ï¼Œæ¥æºç»„ä¹Ÿå¿…é¡»åˆ·æ–°ä¸€æ¬¡ orderï¼Œå¦åˆ™æ—§ç»„çš„ order åºåˆ—ä¼šç©ºæ‰ä¸€ä¸ªæ•°å­—
            if (from !== to) {
                await syncGroup(from);
            }
        }
    });
}

/** åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½ (SortableJS) */
function initSortable(userData) {
    const token = localStorage.getItem('onepanel_token');

    // 1. é“¾æ¥è·¨ç»„æ‹–æ‹½
    document.querySelectorAll('.links-grid').forEach(el => {
        const groupId = el.dataset.groupId;
        const isReadonly = (groupId === "1" && (!userData || userData.id !== 1));

        new Sortable(el, {
            group: 'shared-links',
            animation: 150,
            handle: '.group-drag-handle',
            disabled: isReadonly,
            onEnd: async (evt) => {
                if (evt.to.dataset.groupId === "1" && userData.id !== 1) {
                    alert("å…¬å…±åˆ†ç»„å†…å®¹ä¸å¯ä¿®æ”¹");
                    window.location.reload();
                    return;
                }

                const { from, to } = evt;

                // å®šä¹‰åŒæ­¥å‡½æ•°ï¼šè·å–è¯¥ DOM å®¹å™¨ä¸‹æ‰€æœ‰å¡ç‰‡çš„å½“å‰é¡ºåº
                const syncGroupOrder = async (gridElement) => {
                    const groupId = gridElement.dataset.groupId;
                    // ã€æ ¸å¿ƒã€‘é‡æ–°è·å–å½“å‰ HTML ç»“æ„ä¸­çœŸå®çš„ ID é¡ºåº
                    const linkIds = Array.from(gridElement.querySelectorAll('.link-card'))
                        .map(card => parseInt(card.dataset.linkId));

                    if (linkIds.length === 0 && from === to) return; // æ²¡ä¸œè¥¿å°±ä¸å‘è¯·æ±‚

                    // è°ƒç”¨æˆ‘ä»¬æ–°å†™çš„ reorder æ¥å£ï¼Œä¸€æ¬¡æ€§æŠŠè¿™ä¸€ç»„çš„é¡ºåºå…¨å®šæ­»
                    await fetch(`/api/links/reorder`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            link_ids: linkIds,
                            group_id: parseInt(groupId)
                        })
                    });
                };

                // æ‰§è¡ŒåŒæ­¥ï¼šç›®æ ‡ç»„å¿…é¡»åŒæ­¥
                await syncGroupOrder(to);

                // å¦‚æœæ˜¯è·¨ç»„æ‹–æ‹½ï¼Œæ¥æºç»„ä¹Ÿå°‘äº†ä¸œè¥¿ï¼Œä¹Ÿè¦åŒæ­¥ä¸€æ¬¡é¡ºåºï¼ˆé˜²æ­¢ order åºåˆ—æ–­å±‚ï¼‰
                if (from !== to) {
                    await syncGroupOrder(from);
                }
            }
        });
    });

    // 2. åˆ†ç»„ä¸Šä¸‹æ‹–æ‹½
    new Sortable(document.getElementById('links-container'), {
        animation: 150,
        handle: '.group-drag-handle',
        onEnd: async () => {
            const groupIds = Array.from(document.querySelectorAll('.group-section'))
                .map(el => el.dataset.id);
            // è°ƒç”¨åˆ†ç»„é‡æ’æ¥å£
            await fetch('/api/groups/reorder', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(groupIds)
            });
        }
    });
}

/** è¿›å…¥ç¼–è¾‘æ¨¡å¼ */
function editGroupName(el, groupId) {
    const oldName = el.innerText;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = oldName;
    input.className = 'group-edit-input';

    // å¤±å»ç„¦ç‚¹æˆ–æŒ‰å›è½¦ä¿å­˜
    input.onblur = () => saveGroupName(groupId, input.value, el, oldName);
    input.onkeydown = (e) => {
        if (e.key === 'Enter') input.blur();
        if (e.key === 'Escape') { input.value = oldName; input.blur(); }
    };

    el.innerHTML = '';
    el.appendChild(input);
    input.focus();
}

/** è°ƒç”¨ API ä¿å­˜æ–°åç§° */
async function saveGroupName(groupId, newName, el, oldName) {
    if (!newName.trim() || newName === oldName) {
        el.innerText = oldName;
        return;
    }

    const token = localStorage.getItem('onepanel_token');
    try {
        const res = await fetch(`/api/groups/${groupId}?name=${encodeURIComponent(newName)}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            el.innerText = newName;
            showToast("åç§°å·²æ›´æ–°");
        } else {
            el.innerText = oldName;
            showToast("æ›´æ–°å¤±è´¥", "error");
        }
    } catch (e) {
        el.innerText = oldName;
    }
}

/** åˆ é™¤åˆ†ç»„ç¡®è®¤ */
async function confirmDeleteGroup(groupId) {
    if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤åˆ†ç»„å—ï¼Ÿå…¶ä¸­çš„æ‰€æœ‰é“¾æ¥ä¹Ÿå°†è¢«æ°¸ä¹…åˆ é™¤ï¼")) return;

    const token = localStorage.getItem('onepanel_token');
    const res = await fetch(`/api/groups/${groupId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.ok) {
        showToast("åˆ†ç»„å·²ç§»é™¤");
        renderLinks(document.getElementById('links-container'));
    }
}

/** åŠ¨æ€å¡«å……â€œæ‰€å±åˆ†ç»„â€ä¸‹æ‹‰æ¡† */
async function refreshGroupSelect() {
    const select = document.getElementById('modal-group-id');
    if (!select) return;

    const token = localStorage.getItem('onepanel_token');
    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

    try {
        const res = await fetch('/api/groups/', { headers });
        const groups = await res.json();

        if (groups && groups.length > 0) {
            // å°†è·å–çš„åˆ†ç»„è½¬ä¸º <option> æ ‡ç­¾
            select.innerHTML = groups.map(g =>
                `<option value="${g.id}">${g.name}</option>`
            ).join('');
        } else {
            select.innerHTML = `<option value="">è¯·å…ˆåˆ›å»ºåˆ†ç»„</option>`;
        }
    } catch (e) {
        console.error("åˆ·æ–°åˆ†ç»„ä¸‹æ‹‰æ¡†å¤±è´¥:", e);
        select.innerHTML = `<option value="">åŠ è½½å¤±è´¥</option>`;
    }
}
/** æäº¤æ–°å»ºåˆ†ç»„ */
async function submitAddGroup(event) {
    event.preventDefault();
    const token = localStorage.getItem('onepanel_token');
    const name = document.getElementById('modal-group-name').value;

    const res = await fetch(`/api/groups/?name=${encodeURIComponent(name)}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.ok) {
        showToast("åˆ†ç»„åˆ›å»ºæˆåŠŸ");
        closeGroupModal();
        renderLinks(document.getElementById('links-container'));
    }
}

/** è¾…åŠ©å‡½æ•°ï¼šä»…æ¸²æŸ“é“¾æ¥å¡ç‰‡å­—ç¬¦ä¸² */
function renderLinkCards(links) {
    if (links.length === 0) return `<div class="empty-link-hint">æš‚æ— é“¾æ¥</div>`;

    return links.map(l => {
        const domain = new URL(l.url).hostname;
        const iconUrl = `https://favicon.cccyun.cc/${domain}`;
        const firstLetter = l.title.charAt(0).toUpperCase();

        return `
            <div class="link-card checking" id="link-${l.id}" onmousemove="tiltCard(event, this)" onmouseleave="resetCard(this)">
                <div class="delete-btn" onclick="confirmDelete(event, ${l.id})">Ã—</div>
                <a href="${l.url}" target="_blank">
                    <div class="link-content">
                        <div class="icon-wrapper">
                            <img src="${iconUrl}" class="link-icon" 
                                 onerror="if(!this.dataset.fallback){ this.dataset.fallback=true; this.src='/static/default_link.jpg'; }">
                        </div>
                        <div class="link-title">${l.title}</div>
                    </div>
                </a>
            </div>`;
    }).join('');
}





async function checkUrlAccessibility(url, elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ç§’è¶…æ—¶
        await fetch(url, { mode: 'no-cors', cache: 'no-cache', signal: controller.signal });
        clearTimeout(timeoutId);
        el.classList.remove('inactive'); // ç¡®ä¿å®ƒæ˜¯äº®çš„
    } catch (e) {
        el.classList.add('inactive');    // å¤±è´¥åˆ™å˜ç°
    } finally {
        el.classList.remove('checking'); // æ— è®ºå¦‚ä½•ï¼Œåœæ­¢å‘¼å¸ç¯åŠ¨ç”»
    }

}

function sortLinksByStatus() {
    const container = document.getElementById('links-container');
    // åªé€‰å–å…·æœ‰ link-card ç±»çš„å…ƒç´ è¿›è¡Œæ’åº
    const cards = Array.from(container.querySelectorAll('.link-card'));
    cards.sort((a, b) => {
        const aStatus = a.classList.contains('inactive') ? 1 : 0;
        const bStatus = b.classList.contains('inactive') ? 1 : 0;
        return aStatus - bStatus;
    });

    // é‡ç‚¹ï¼šä½¿ç”¨ documentFragment å‡å°‘é‡ç»˜æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½
    const fragment = document.createDocumentFragment();
    cards.forEach(card => fragment.appendChild(card));
    container.appendChild(fragment);
}

window.confirmDelete = async function (e, id) {
    e.stopPropagation(); // é˜²æ­¢è§¦å‘è·³è½¬
    if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé“¾æ¥å—ï¼Ÿ")) return;
    const token = localStorage.getItem('onepanel_token');
    const res = await fetch(`/api/links/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (res.ok) {
        showToast("å·²åˆ é™¤é“¾æ¥");
        initPage(); // é‡æ–°åŠ è½½åˆ—è¡¨
    }

};



async function triggerHealthCheck() {
    const token = localStorage.getItem('onepanel_token');
    if (token) {
        fetch('/api/links/check-health', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(() => renderLinks(document.getElementById('links-container')));
    }
}

/** æ·»åŠ é“¾æ¥é€»è¾‘ */

async function submitAddLink(event) {
    event.preventDefault();
    const token = localStorage.getItem('onepanel_token');
    if (!token) return showToast("è¯·å…ˆç™»å½•", "error");

    // è·å–åˆ†ç»„ ID å¹¶è½¬ä¸ºæ•´æ•°
    const groupId = parseInt(document.getElementById('modal-group-id').value);

    if (!groupId) {
        return showToast("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç»„", "error");
    }

    const linkData = {
        title: document.getElementById('modal-link-title').value,
        url: document.getElementById('modal-link-url').value,
        group_id: groupId, // å¿…é¡»ä¸ LinkCreate Schema ä¸­çš„å­—æ®µåä¸€è‡´
        icon: "",
        order: 0
    };

    try {
        // æ³¨æ„ï¼šè¿™é‡Œçš„è·¯å¾„åŠ äº†æœ«å°¾æ–œæ  / é¿å… 307 è·³è½¬
        const res = await fetch('/api/links/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(linkData)
        });

        if (res.ok) {
            closeModal();
            showToast("æ·»åŠ æˆåŠŸï¼Œæ­£åœ¨åŒæ­¥ç©ºé—´...");
            renderLinks(document.getElementById('links-container')); // é‡æ–°æ¸²æŸ“
        } else {
            const err = await res.json();
            // å¦‚æœè¿˜æ˜¯ 422ï¼Œè¿™é‡Œä¼šæ‰“å°å‡ºå…·ä½“æ˜¯å“ªä¸ªå­—æ®µé”™äº†
            console.error("æäº¤å¤±è´¥è¯¦æƒ…:", err);
            showToast(err.detail[0].msg || "ä¿å­˜å¤±è´¥", "error");
        }
    } catch (e) {
        console.error("ç½‘ç»œå¼‚å¸¸:", e);
    }
}

/** èƒŒæ™¯ä¸Šä¼  */
document.getElementById('bg-input').onchange = async (e) => {
    const file = e.target.files[0];
    const token = localStorage.getItem('onepanel_token');
    if (!file || !token) return;
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch('/api/upload-bg', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
    });
    if (res.ok) {
        showToast("èƒŒæ™¯å·²æ›´æ–° âœ¨");
        setTimeout(() => location.reload(), 1500);
    } else {
        showToast("ä¸Šä¼ å¤±è´¥", "error");
    }
};



/**

 * æ˜¾ç¤ºæç¤ºæ¶ˆæ¯ (Toast)

 * @param {string} msg æ¶ˆæ¯å†…å®¹

 * @param {string} type ç±»å‹: success | error

 */

window.showToast = function (msg, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const icon = type === 'success' ? 'âœ…' : 'âŒ';
    toast.innerHTML = `
        <span style="font-size: 18px;">${icon}</span>
        <span style="font-size: 14px; font-weight: 500;">${msg}</span>
    `;

    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => toast.remove(), 400);
    }, 3000);

};


// å¼¹çª—æ§åˆ¶åˆ†ç»„
window.openLinkModal = function () {
    refreshGroupSelect(); // æ‰“å¼€æ—¶åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
    document.getElementById('add-link-modal').classList.add('active');
};

window.openGroupModal = function () {
    document.getElementById('add-group-modal').classList.add('active');
};

window.closeGroupModal = function () {
    document.getElementById('add-group-modal').classList.remove('active');
};



/** å¼¹çª—æ§åˆ¶ **/

window.openModal = async function () {
    const modal = document.getElementById('add-link-modal');
    if (modal) {
        // 1. æ ¸å¿ƒä¿®å¤ï¼šæ‰“å¼€å‰å…ˆå¡«å……ä¸‹æ‹‰æ¡†
        await refreshGroupSelect();

        modal.classList.add('active');
    } else {
        console.error("æ‰¾ä¸åˆ° ID ä¸º add-link-modal çš„å¼¹çª—å…ƒç´ ");
    }
};



window.closeModal = function () {
    const modal = document.getElementById('add-link-modal');
    modal.classList.remove('active');
    setTimeout(() => {
        document.getElementById('modal-link-title').value = '';
        document.getElementById('modal-link-url').value = '';
    }, 300);
};

function logout() {
    localStorage.removeItem('onepanel_token');
    location.reload();
}



/** æœç´¢å¼•æ“é€»è¾‘ **/
function initSearchLogic() {
    const pill = document.getElementById('engine-selector');
    const menu = document.getElementById('engine-dropdown');
    if (!pill) return;
    pill.onclick = (e) => { e.stopPropagation(); menu.classList.toggle('active'); };
    document.addEventListener('click', () => menu.classList.remove('active'));
}



function setEngine(event, key) {
    if (event) event.stopPropagation();
    currentEngine = key;
    document.getElementById('current-engine-logo').src = ENGINES[key].logo;
    document.getElementById('search-input').placeholder = `ä½¿ç”¨ ${ENGINES[key].name} æœç´¢...`;
    document.getElementById('engine-dropdown').classList.remove('active');
    document.getElementById('search-input').focus();
}



function handleSearch(event) {
    if (event.key === 'Enter') {
        const q = document.getElementById('search-input').value;
        if (q.trim()) window.open(ENGINES[currentEngine].url + encodeURIComponent(q), '_blank');
    }
}



// ç»‘å®šå…¨å±€
window.onload = initPage;